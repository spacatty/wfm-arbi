/**
 * Generates src/data/tradable-r10-mods.ts — the authoritative list of tradable
 * rank-10 mod slugs, sourced directly from the warframe.market v2 API.
 *
 * Uses WFM as the single source of truth: if a mod is listed on WFM with
 * maxRank === 10, it's tradable and has a valid slug. No slug guessing needed.
 *
 * Run:  node scripts/generate-r10-mod-list.mjs
 *       npm run generate:r10-mods
 */

import { writeFileSync, mkdirSync } from "fs";
import { dirname, join } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));
const OUT_DIR = join(__dirname, "..", "src", "data");
const OUT_FILE = join(OUT_DIR, "tradable-r10-mods.ts");

const WFM_API = "https://api.warframe.market/v2/items";

async function main() {
  console.log(`[WFM] Fetching items from ${WFM_API} …`);
  const res = await fetch(WFM_API, {
    headers: { Language: "en", Platform: "pc", Accept: "application/json" },
  });
  if (!res.ok) {
    throw new Error(`WFM API error: ${res.status} ${res.statusText}`);
  }
  const json = await res.json();
  const allItems = json.data;
  console.log(`[WFM] Received ${allItems.length} total items.`);

  // Filter: must be a mod with maxRank 10
  const r10Mods = allItems.filter(
    (item) => item.tags?.includes("mod") && item.maxRank === 10
  );

  const slugs = r10Mods.map((m) => m.slug).sort();

  console.log(`[WFM] Found ${slugs.length} tradable R10 mods.`);
  console.log(`  Primed: ${slugs.filter((s) => s.startsWith("primed_")).length}`);
  console.log(`  Non-primed: ${slugs.filter((s) => !s.startsWith("primed_")).length}`);

  // Build human-readable name map (slug → display name) for reference
  const nameMap = {};
  for (const m of r10Mods) {
    nameMap[m.slug] = m.i18n?.en?.name ?? m.slug;
  }

  mkdirSync(OUT_DIR, { recursive: true });

  const content = `/**
 * Tradable rank-10 mod slugs — sourced from the warframe.market v2 API.
 * These are verified WFM slugs; every entry is guaranteed to exist on WFM.
 *
 * Generated by scripts/generate-r10-mod-list.mjs — do not edit by hand.
 * Run \`npm run generate:r10-mods\` to regenerate.
 *
 * Total: ${slugs.length} mods  (${slugs.filter((s) => s.startsWith("primed_")).length} primed, ${slugs.filter((s) => !s.startsWith("primed_")).length} normal)
 * Generated: ${new Date().toISOString()}
 */
export const TRADABLE_R10_MOD_SLUGS: readonly string[] = ${JSON.stringify(slugs, null, 2)} as const;

/**
 * Slug → human-readable display name.
 */
export const R10_MOD_DISPLAY_NAMES: Record<string, string> = ${JSON.stringify(nameMap, null, 2)};
`;

  writeFileSync(OUT_FILE, content, "utf8");
  console.log(`\nWrote ${slugs.length} verified R10 mod slugs to ${OUT_FILE}`);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
